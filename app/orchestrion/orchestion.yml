# yaml-language-server: $schema=https://datadoghq.dev/orchestrion/schema.json
meta:
  name: otel-orchestrion
  description: Enables running the OTel SDK under the hood with Orchestrion

aspects:
  - id: initialize OTel tracer
    join-point:
      all-of:
        - package-name: main
        - function-body:
            function:
              - name: main
              - signature: {}
    advice:
      - inject-declarations:
          imports:
            handlers: github.com/hannahkm/gopherconus-2025/handlers
            context: context
          template: |-
            var otelShutdown func(context.Context) error
            var provider *trace.TracerProvider
            
            func init() {
              provider = trace.NewTracerProvider(
                trace.WithBatcher(exporter,
                  trace.WithBatchTimeout(5*time.Second),
                  trace.WithMaxExportBatchSize(100),
                  trace.WithMaxQueueSize(1000),
                ),
                trace.WithResource(res),
              )
              otelShutdown = provider.Shutdown
            }
      - prepend-statements:
          imports:
            context: context
            log: log
          template: |-
            defer func() {
              if otelShutdown != nil {
                if err := otelShutdown(context.Background()); err != nil {
                  log.Printf("Error shutting down OTel provider: %v", err)
                }
              }
            }()

  - id: Update Handlers
    join-point:
      function:
        - signature-contains:
            returns:
              - *net/http.Handler
              - *http.HandlerFunc
    advice:
      prepend-statements:
        imports:
          - otel: go.opentelemetry.io/otel
        template: |-
          {{ $r := .Function.ResultThatImplements "*http.ResponseWriter" }}
          {{ with $r }}
            tracer := otel.Tracer("orchestrion")
            ctx, span := tracer.Start({{ $r }}.Context(), "orchestrion.handler")
            defer func() {
              span.End()
            }()
            *{{ $r }} = *{{ $r }}.WithContext(ctx)
          {{- end -}}

  - id: Create OTel Handlers
    join-point:
      function-body:
        function:
          - name: setupHandlers
    advice:
      prepend-statements:
        imports:
          otelhttp: go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp
          http: net/http
        template: |-
          {{ $ret := .Function.ResultThatImplements "net/http.Handler" }}
          {{ $inputs := .Function.Arguments.FirstThatImplements "*main.Input" }}
          {{ if and $ret $inputs }}
            mux := http.NewServeMux()
            handleFunc := func(pattern string, handlerFunc func(http.ResponseWriter, *http.Request)) {
              // Configure the "http.route" for the HTTP instrumentation.
              handler := otelhttp.WithRouteTag(pattern, http.HandlerFunc(handlerFunc))
              mux.Handle(pattern, handler)
            }
            handleFunc("/health", healthHandler)
            handleFunc("/load/1", {{ $inputs }}.loadHandler)

            {{ $ret }} = otelhttp.NewHandler(mux, "/")
            return {{ $ret }}
          {{- end -}}