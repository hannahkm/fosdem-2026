# yaml-language-server: $schema=https://datadoghq.dev/orchestrion/schema.json
meta:
  name: otel-orchestrion
  description: Enables running the OTel SDK under the hood with Orchestrion

aspects:
  - id: initialize OTel tracer
    join-point:
      all-of:
        - package-name: main
        - function-body:
            function:
              - name: main
              - signature: {}
    advice:
      - inject-declarations:
          imports:
            context: context
            os: os   
            time: time 
            trace: go.opentelemetry.io/otel/sdk/trace
            otlptracehttp: go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp
            resource: go.opentelemetry.io/otel/sdk/resource
            otel: go.opentelemetry.io/otel
            semconv: go.opentelemetry.io/otel/semconv/v1.20.0
          template: |-
            var otelShutdown func(context.Context) error
            var provider *trace.TracerProvider
            
            func init() {
              ctx := context.Background()

              endpoint := os.Getenv("OTEL_EXPORTER_OTLP_ENDPOINT")
              if endpoint == "" {
                endpoint = "localhost:4318"
              }

              exporter, err := otlptracehttp.New(ctx,
                otlptracehttp.WithInsecure(),
                otlptracehttp.WithEndpoint(endpoint),
                otlptracehttp.WithTimeout(30*time.Second),
              )
              if err != nil {
                os.Exit(1)
              }

              res, err := resource.New(ctx,
                resource.WithAttributes(
                  semconv.ServiceName("orchestrion"),
                  semconv.ServiceVersion("1.0.0"),
                ),
              )

              provider = trace.NewTracerProvider(
                trace.WithBatcher(exporter,
                  trace.WithBatchTimeout(5*time.Second),
                  trace.WithMaxExportBatchSize(100),
                  trace.WithMaxQueueSize(1000),
                ),
                trace.WithResource(res),
              )
              otelShutdown = provider.Shutdown
              otel.SetTracerProvider(provider)
            }
      - prepend-statements:
          imports:
            context: context
            log: log
          template: |-
            defer func() {
              if otelShutdown != nil {
                if err := otelShutdown(context.Background()); err != nil {
                  log.Printf("Error shutting down OTel provider: %v", err)
                }
              }
            }()

  - id: Update Handlers
    join-point:
      function:
        - signature-contains:
            returns:
              - "*http.Handler"
              - "*http.HandlerFunc"
    advice:
      prepend-statements:
        imports:
          otel: go.opentelemetry.io/otel
        template: |-
          {{ $r := .Function.ResultThatImplements "*http.ResponseWriter" }}
          {{ with $r }}
            tracer := otel.Tracer("orchestrion")
            ctx, span := tracer.Start({{ $r }}.Context(), "orchestrion.handler")
            defer func() {
              span.End()
            }()
            *{{ $r }} = *{{ $r }}.WithContext(ctx)
          {{- end -}}

  - id: Create OTel Handlers
    join-point:
      function-body:
        function:
          - name: setupHandlers
    advice:
      prepend-statements:
        imports:
          otelhttp: go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp
          http: net/http
        template: |-
          {{ $ret := .Function.ResultThatImplements "net/http.Handler" }}
          {{ $inputs := .Function.Argument 0}}
          {{ if and $ret $inputs }}
            mux := http.NewServeMux()
            mux.HandleFunc("/health", HealthHandler)
            mux.HandleFunc("/load/1", inputs.LoadHandler)

            {{ $ret }} = otelhttp.NewHandler(mux, "/")
            return {{ $ret }}
          {{- end -}}